<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org">
<head>
  <title>Sales & Collections Entry</title>
  <link
    href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css"
    rel="stylesheet"
  >
  <script>
    function addProductRow() {
      const container = document.getElementById("products");
      const div = document.createElement("div");
      div.className = "row g-2 mb-3 product-group border rounded p-3 bg-light position-relative";

      div.innerHTML = `
        <div class="col-md-4">
          <select name="product" class="form-control" required>
            <option value="" disabled selected>Select Product</option>
            <option value="petrol">Petrol</option>
            <option value="diesel">Diesel</option>
            <option value="other">Other</option>
          </select>
        </div>
        <div class="col-md-4">
          <select name="subProduct" class="form-control" required>
            <option value="" disabled selected>Select Sub-Product</option>
            <option value="G1">G1</option>
            <option value="G2">G2</option>
            <option value="G3">G3</option>
          </select>
        </div>
        <div class="col-md-2">
          <input name="opening" type="number" step="any" class="form-control" placeholder="Opening">
        </div>
        <div class="col-md-2">
          <input name="closing" type="number" step="any" class="form-control" placeholder="Closing">
        </div>
        <div class="col-md-4">
          <input name="price" type="number" step="any" class="form-control" placeholder="Price" required>
        </div>
        <div class="col-md-4">
          <input name="testing" type="number" step="any" class="form-control" placeholder="Testing">
        </div>
        <div class="col-12 d-flex justify-content-end">
          <button
            type="button"
            class="btn btn-outline-danger btn-sm mt-2"
            onclick="removeProductRow(this)">
            Remove
          </button>
        </div>
      `;
      container.appendChild(div);

      // Autoâ€fill Opening from last Closing
      const prod = div.querySelector('select[name="product"]');
      const sub  = div.querySelector('select[name="subProduct"]');
      const open = div.querySelector('input[name="opening"]');

      function updateOpening() {
        if (!prod.value || !sub.value) return;
        fetch(
          `/sales/last?productName=${encodeURIComponent(prod.value)}&subProduct=${encodeURIComponent(sub.value)}`
        )
          .then(r => r.ok ? r.json() : Promise.reject(r.statusText))
          .then(d => { open.value = d.lastClosing; })
          .catch(console.error);
      }

      prod.addEventListener("change", updateOpening);
      sub .addEventListener("change", updateOpening);
    }

    function removeProductRow(btn) {
      btn.closest(".product-group").remove();
    }

    function collectProducts() {
      return Array.from(document.querySelectorAll(".product-group")).map(group => {
        const f = group.querySelectorAll("select, input");
        return {
          productName: f[0].value,
          subProduct:  f[1].value,
          opening:     parseFloat(f[2].value || 0),
          closing:     parseFloat(f[3].value || 0),
          price:       parseFloat(f[4].value),
          testing:     parseFloat(f[5].value || 0)
        };
      });
    }

    function submitSales(e) {
      e.preventDefault();
      const payload = {
        date:        document.getElementById("salesDate").value,
        employeeId:  +document.getElementById("salesEmployeeId").value,
        products:    collectProducts()
      };
      fetch("/sales", {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body:    JSON.stringify(payload)
      })
      .then(r => r.text())
      .then(msg => alert("Sales Saved: " + msg))
      .catch(err => alert("Error: " + err));
    }

    function submitCollections(e) {
      e.preventDefault();
      const payload = {
        date:                document.getElementById("collectionsDate").value,
        employeeId:          +document.getElementById("collectionsEmployeeId").value,
        cashReceived:        parseFloat(document.getElementById("cashReceived").value || 0),
        cashReceivedStatus:  document.getElementById("cashReceivedStatus").value,
        phonePay:            parseFloat(document.getElementById("phonePay").value || 0),
        phonePayStatus:      document.getElementById("phonePayStatus").value,
        creditCard:          parseFloat(document.getElementById("creditCard").value || 0),
        creditCardStatus:    document.getElementById("creditCardStatus").value,
        borrowedAmount:      parseFloat(document.getElementById("borrowedAmount").value || 0),
        debtRecovered:       parseFloat(document.getElementById("debtRecovered").value || 0),
        borrower:            document.getElementById("borrower").value,
        badHandling:         parseFloat(document.getElementById("badHandling").value || 0),
        expenses:            parseFloat(document.getElementById("expenses").value || 0)
      };
      fetch("/collections", {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body:    JSON.stringify(payload)
      })
      .then(r => r.text())
      .then(msg => alert("Collections Saved: " + msg))
      .catch(err => alert("Error: " + err));
    }

    window.onload = () => addProductRow();
  </script>
</head>
<body class="bg-body-tertiary">
  <div class="container py-4">
    <h2 class="mb-4">Sales & Collections Dashboard</h2>

    <!-- Sales Form -->
    <form onsubmit="submitSales(event)" class="mb-5 border p-4 rounded bg-white shadow-sm">
      <h4>Sales Entry</h4>
      <div class="row g-3 mb-3">
        <div class="col-md-6">
          <input type="date" class="form-control" id="salesDate" required>
        </div>
        <div class="col-md-6">
          <input type="number" class="form-control" id="salesEmployeeId" placeholder="Employee ID" required>
        </div>
      </div>
      <div id="products"></div>
      <button type="button" class="btn btn-outline-primary mt-2" onclick="addProductRow()">Add Product</button>
      <button type="submit" class="btn btn-success mt-2 float-end">Submit Sales</button>
    </form>

    <!-- Collections Form -->
    <form onsubmit="submitCollections(event)" class="border p-4 rounded bg-white shadow-sm">
      <h4>Collections Entry</h4>
      <div class="row g-3 mb-3">
        <div class="col-md-6">
          <input type="date" class="form-control" id="collectionsDate" required>
        </div>
        <div class="col-md-6">
          <input type="number" class="form-control" id="collectionsEmployeeId" placeholder="Employee ID" required>
        </div>
      </div>
      <div class="row g-3 mb-3">
        <div class="col-md-6">
          <input type="number" step="any" class="form-control" id="cashReceived" placeholder="Cash Received">
        </div>
        <div class="col-md-6">
          <input type="text" class="form-control" id="cashReceivedStatus" placeholder="Cash Received Status">
        </div>
        <div class="col-md-6">
          <input type="number" step="any" class="form-control" id="phonePay" placeholder="Phone Pay">
        </div>
        <div class="col-md-6">
          <input type="text" class="form-control" id="phonePayStatus" placeholder="Phone Pay Status">
        </div>
        <div class="col-md-6">
          <input type="number" step="any" class="form-control" id="creditCard" placeholder="Credit Card">
        </div>
        <div class="col-md-6">
          <input type="text" class="form-control" id="creditCardStatus" placeholder="Credit Card Status">
        </div>
        <div class="col-md-6">
          <input type="number" step="any" class="form-control" id="borrowedAmount" placeholder="Borrowed Amount">
        </div>
        <div class="col-md-6">
          <input type="number" step="any" class="form-control" id="debtRecovered" placeholder="Debt Recovered">
        </div>
        <div class="col-md-6">
          <input type="text" class="form-control" id="borrower" placeholder="Borrower Name">
        </div>
        <div class="col-md-6">
          <input type="number" step="any" class="form-control" id="badHandling" placeholder="Bad Handling">
        </div>
        <div class="col-md-6">
          <input type="number" step="any" class="form-control" id="expenses" placeholder="Expenses">
        </div>
      </div>
      <button type="submit" class="btn btn-success float-end">Submit Collections</button>
    </form>

  </div>
</body>
</html>


